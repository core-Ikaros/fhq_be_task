# TCP/IP通信传输流

- 应用层

  解决具体的网络问题，例如发出请求。

- 传输层

  将报文分割，打上标记，端口号。

- 网络层

  增加MAC地址，定位目标

- 链路层

  传输数据。







## HTTP方法

### GET：获取资源

  客户端访问服务器上的资源，关键是**响应**的内容。

### POST：传输实体主题

客户端向服务器传输数据，关键是**请求**的内容。

### PUT：传输文件

同样是向客户端传输数据，和POST区别在于PUT指定了请求URI，而POST由服务器每次自动在新URI保存数据。也就是**保存更新**和**另存为**的关系。

### HEAD：获得报文首部

和GET一样，但**不返回报文主题**，只返回头部用于获得资源更新日期等**资源信息**。

### DELETE：删除文件

**删除**服务器上请求URI的资源，可看作反向的PUT。

### OPTIONS：

用来查询请求URI的资源支持的方法。

### TRACE：追踪路径

获得服务器接受到的请求，可以查询请求是**怎样被修改**的。**不常用**。

### CONNECT：要求用隧道协议连接代理

https协议加密信息，代理服务器无法检查请求内容，也**无法解析出目标地址**。CONNECT方法提供目标服务器地址，在**代理和目标间建立隧道**，将加密数据通过隧道传输。

## Cookie

HTTP 是无状态协议，它不对之前的状态进行管理。比如每次登陆账号后退出，页面不保存登陆状态，需要再次登录。
Cookie技术通过在请求、响应报文中写入Cookie信息来控制客户端的状态。

流程：客户端发出请求-->服务器端在响应中**生成Cookie发回**，客户端**保存Cookie**-->客户端再次发送请求时**加入Cookie**，服务器端**检查Cookie**，在存储的记录中比对确定客户端身份，得到状态信息。

HTTP协议本身不储存状态信息，服务器端是在**自己的存储**中查找的。

## MIME（多用途因特网邮件扩展）

用于在报文中加入**多种类型的数据**，如文本、图片等。

### multipart/form-data

用于上传**不同类型**的数据：

  POST /register HTTP/1.1
  Content-Type: multipart/form-data; boundary=----Boundary123

  ----Boundary123
  Content-Disposition: form-data; name="username"

  张三
  ----Boundary123
  Content-Disposition: form-data; name="avatar"; filename="photo.jpg"
  Content-Type: image/jpeg

  ..这里是photo.jpg的二进制数据...
  ----Boundary123--

- boundary=……  作为分隔符分割不同类型数据。
- Content-Disposition  form-data：固定格式，声明这是一个**表单数据项**。
- name="……"  声明**表单名称**，对应HTML中`<input>`标签的`name`属性。
- Content-Type: image/jpeg  如果这部分是文件，则加入这一段声明它的**类型**。
- filename="file.name"  如果这部分数据是文件，则加入这一段指定**文件名**，

### multipart/byteranges

用于返回**一个资源**的几个部分（也就是说所有部分**类型相同**）

  客户端请求：
  GET /large-file.pdf HTTP/1.1
  Range: bytes=0-100, 200-300

  服务器响应：
  HTTP/1.1 206 Partial Content
  Content-Type: multipart/byteranges; boundary=Boundary456

  --Boundary456
  Content-Type: application/pdf
  Content-Range: bytes 0-100/5000

  ...这里是large-file.pdf的第0-100字节数据...
  --Boundary456
  Content-Type: application/pdf
  Content-Range: bytes 200-300/5000

  ...这里是large-file.pdf的第200-300字节数据...
  --Boundary456--

## 范围请求

用于请求下载指定部分的数据，比如下载意外中断后，可以请求只下载剩余内容。

请求报文：

  GET /tip.jpg HTTP/1.1
  Host: www.usagidesign,jp
  Range: byte =5001-10000

Range指定资源的byte范围：

`Range: bytes=5001-10000`

  5001~10 000 字节。

`Range: bytes=5001-`

  从 5001 字节之后全部的。

`Range: bytes=-3000, 5000-7000`

  从一开始到 3000 字节和 5000~7000 字节的多重范围。

## 内容协商返回最合适的内容

同一个 Web 网站有可能存在着多份相同内容的页面。比如英语版和
中文版的 Web 页面，它们内容上虽相同，但使用的语言却不同。

当浏览器的默认语言为英语或中文，访问相同 URI 的 Web 页面时，
则会显示对应的英语版或中文版的 Web 页面。这样的机制称为**内容协商**。

请求报文中使用一些首部字段作为判断的基准。后面会提。

三种内容协商类型：

- 服务器驱动协商

  由服务器端进行内容协商。以请求的首部字段为参考，在服务器端自动处理。

- 客户端驱动协商

  由客户端进行内容协商的方式。用户通过浏览器显示的可选项列表或其他方式选择。

- 透明协商

  由服务器端和客户端各自进行内容协商的一种方法。

# 返回结果的 HTTP 状态码

状态码如`200 OK`，以 3 位数字和原因短语组成，
表示客户端 HTTP 请求的返回结果、标记服务器端的处理是否正常、通知出现的错误等工作。

数字中的第一位指定了响应类别，后两位无分类。响应类别有以下5种，而常用状态码共有14个。

## 2XX 成功

表明请求被正常处理了。

### 200 OK

表示从客户端发来的请求在服务器端被正常处理了。

### 204 No Content

表示服务器接收的请求已成功处理，但在返回的响应报文中不含实体的主体部分，
一般在只需要从客户端往服务器发送信息，而对客户端不需要发送新信息内容的情况下使用。

### 206 Partial Content

表示客户端进行了范围请求，而服务器成功执行了这部分的请求。

## 3XX 重定向

表示浏览器需要执行某些特殊的处理以正确处理请求。
重定向指的是请求服的资源的URL变动，需要换为新的URL

### 301 Moved Permanently

表示请求的资源已有了新的URI，以后应使用资源现在所指的URI。

### 302 Found

表示请求的资源已被临时分配了新的 URI，希望用户能使用新的 URI 访问。

### 303 See Other

表示由于请求对应的资源存在着另一个 URI，应使用 GET方法定向获取请求的资源。
比如使用POST方法提交数据后返回303，再用GET从重定向的 URL 获取资源。

> 当 301、302、303 响应状态码返回时，几乎所有的浏览器都会把 POST 改成 GET，
> 并删除请求报文内的主体，之后请求会自动再次发送。

### 304 Not Modified

表示客户端发送附带条件的请求时，服务器端允许请求访问资源，但提示未满足条件。
304 虽然被划分在 3XX 类别中，但是和重定向没有关系。

### 307 Temporary Redirect

与 302 Found 类似，但不会自动将 POST 换为 GET。

## 4XX 客户端错误

表明客户端发生错误。

### 400 Bad Request

表示请求报文中存在语法错误。

### 401 Unauthorized

表示客户端身份未知，需要验证。
返回含有 401 的响应必须包含适用于被请求资源的 W-Authenticate 首部用以询问用户信息。当浏览器初次接收
到 401 响应，会弹出认证用的窗口。

### 403 Forbidden

服务器理解请求，也找到了资源，但拒绝返回，客户端没有足够的权限访问该资源。

### 404 Not Found

服务器找不到客户端请求的资源，这个 URI 在服务器上不存在。

## 5XX 服务器错误

表明服务器本身发生错误。

### 500 Internal Server Error

服务器内部出现问题，导致它无法完成请求。

### 503 Service Unavailable

服务器当前无法处理请求，通常是由于临时过载或维护。

# 服务器

## 用单台虚拟主机实现多个域名

服务器能用虚拟主机服务托管多个域名，但这些域名用DNS解析出的IP地址都是相同的。需要在请求的Host头部
指明目标域名。

  GET /news/article.html HTTP/1.1
  **Host: www.hackr.jp**
  Accept: text/html
  User-Agent: Mozilla/5.0...

## 通信数据转发程序 ：代理、网关、隧道

有一些用于通信数据转发的应用程序，例如代理、网关和隧道，和服务器搭配使用作为通信的中转。

### 代理

代理是客户端和服务器之间的中间人，**代表客户端**向服务器发送请求。
魔法上网就是用代理隐藏客户端真实IP地址的。

- 缓存代理

  代理转发响应时，缓存代理会预先**将资源副本保存在代理服务器**上。
  当代理再次接收到对相同资源的请求时，就可以不从源服务器那里获取资源，
  而是将**之前缓存的资源作为响应**返回。

- 透明代理

  不对报文做任何加工。反之如有加工则为不透明代理。

### 网关

是转发其他服务器通信数据的服务器，接收从客户端发送来的请求时，它就像自己拥有资源的源服务器一样对请求进行处理。
有时客户端可能都不会察觉，自己的通信目标是一个网关。
有点像海关，在不同网络或协议中间作为**转换器**。

### 隧道

是在不安全的网络上创建安全通道的技术，对传输的数据进行封装。
学校VPN使用隧道，让学生能安全访问学校服务器。

## 保存资源的缓存

是指代理服务器或客户端本地保存的资源副本。
利用缓存可减少对源服务器的访问，节省了通信流量和通信时间。

### 缓存的有效期限

缓存的资源会因为源服务器资源更新，客户端要求改变而失效。缓存服务器（有缓存代理）会检查有效性，
并在需要时从源服务器处更新缓存。

### 客户端的缓存

除了缓存服务器，客户端浏览器也能缓存。如果有效，可以直接从本地读取。同样会判断有效性。

# HTTP 首部

## HTTP 报文首部


### HTTP 请求报文

请求报文首部由方法、URI、HTTP 版本、HTTP 首部字段等构成

### HTTP 响应报文

请求报文首部由HTTP 版本、状态码、HTTP 首部字段构成

## HTTP 首部字段

包括 HTTP 报文相关的内容信息。

### HTTP 首部字段结构

由首部字段名和字段值构成的，中间用冒号“:” 分隔。字段名可以有多个字段值，用“,”分隔。

### 4 种 HTTP 首部字段类型

- 通用首部字段

  请求，响应报文首部都有

- 请求首部字段

  请求报文使用

- 响应首部字段

  响应报文使用

- 实体首部字段

  补充报文主体，即实体有关的信息

### End-to-end 首部和 Hop-by-hop 首部

端到端首部（End-to-end Header）是在中转中不变，一直传递到接收端的。
每一个中转服务器都能接受到端对端首部字段。

逐跳首部（Hop-by-hop Header）是只在下一个中转服务器起作用的首部，其中的字段作用后被删除。
可以用一些方法让中转服务器生成逐跳首部。

## HTTP/1.1 通用首部字段

### Cache-Control

控制缓存的行为。

- public 响应

  `Cache-Control: public`

  表明其他用户也可使用缓存。

- private 响应

  `Cache-Control: private`

  表明只有特定用户也可利用缓存。

- no-cache 通用

  `Cache-Control: no-cache`

  在请求报文中表明不使用缓存,直接从源服务器中获得资源；
  在响应报文中表明服务器不能缓存过期资源。

- no-store 通用

  `Cache-Control: no store`

  表明不能缓存资源。

- maxage 通用

  `Cache-Control: maxage=604800（单位：秒）`

  在请求报文中表明如果判定缓存资源的缓存时间数值比指定时间的数值更小，那么客户端就使用缓存的资源。
  在响应报文中表明缓存服务器缓存此资源的最长时间。

- s-maxage 通用

  `Cache-Control: s-maxage`

  和maxage一致，区别在于s-maxage只适用于供多位用户使用的公共缓存服务器（一般是代理）。

- min-fresh 请求

  `Cache-Control: min-fresh=60（单位：秒）`

  表明缓存服务器返回缓存资源，此资源距离过期的时间不能低于指定时间。
  翻译：返回的资源要保证在接下来的指定时间内都是最新的。

- max-stale 请求

  `Cache-Control: max-stale=3600（单位：秒）`

  表明缓存服务器返回指定时间内的缓存资源，不管有没有过期。
  如果没指定时间则不管多久的资源都接收。

- only-if-cached 请求

  `Cache-Control: only-if-cached`

  表明只接受缓存，如果没有缓存就返回错误。

- must-revalidate 请求

  `Cache-Control: must-revalidate`

  表明若缓存过期，就不返回资源，而是向源服务器验证是否真的过期。

- proxy-revalidate 请求

  `Cache-Control: proxy-revalidate`

  和must-revalidate一样，但只对公共缓存服务器有作用。

- no-transform 请求

  `Cache-Control: no-transform`

  表明禁止中转服务器对主体进行压缩，格式转换等转换。

### Connection

- 逐跳首部

  `Connection: 不再转发的首部字段名`

  逐跳首部的格式。

- close 响应

  `Connection: close`

  HTTP/1.1 版本的默认连接都是持久连接,此字段用于切断链接。

- Keep-Alive 请求

  `Connection: Keep-Alive`

  HTTP/1.1 之前的 HTTP 版本的默认连接都是非持久连接，此字段用于保持连接。

### Date 通用

用于表示报文创建的日期，时间。

### Pragma 请求

  `Pragma: no-cache`

  适配HTTP/1.1 之前版本，用于拒绝使用缓存资源。
  为了拒绝缓存的指令能覆盖使用不同HTTP协议版本的服务器，通常用这样的搭配：

    Cache-Control: no-cache
    Pragma: no-cache

### Trailer 请求

  `Trailer: Expires，……`

  表示字段值表示的首部字段放在主体后面，目前不清楚能做什么。

### Transfer-Encoding 请求

规定传输报文主体用的编码方式。

### Upgrade 请求

表示申请将一段链接换成其他协议通信。
- 这是逐跳首部，要搭配Connection。

### Via

用于记录报文经过的代理和网关。
格式为：协议版本 主机名 【注释】

### Warning

用于携带关于报文的警告信息。
格式为：[警告码][警告的主机:端口号]“[警告内容]”

字段好多……有些不一定常用吧，先到下一个模块好了。

# 确保 Web 安全的HTTPS

用SSL（Secure Socket Layer，安全套接层）或TLS（Transport Layer Security，安全层传输协议）加密解密HTTP报文，
就是HTTPS

## 加密

### 对称加密

使用同一个密钥加解密，由发送端生成。

发送端需要将对称密钥发送给接收端，存在泄露风险。

### 非对称加密

使用对应的公钥，私钥。公钥加密，私钥解密，反过来也可以。公钥公开，但私钥只有接收端有。
都由接收端生成，公钥明文传输给发送端。

流程：

- 两端各自生成一对公私钥，进行第一次连接。
- 客户端，服务器端分别作为发送端发送自己的公钥。此时公钥是可见的。
- 发送端使用接收端的公钥加密报文发送，接收端用自己的私钥解密。

### 混合加密

混合使用两种加密方式。

流程：

- 服务器端生成公私钥，将公钥发送给客户端。
- 客户端生成对称密钥。
- 用对称密钥加密报文，再用公钥加密对称密钥本身，一起发送给服务器端。
- 服务器端用私钥解密出对称密钥，再用对称密钥解密报文。
- 现在两端都有了对称密钥，直接使用对称加密的方式加解密报文。

## 数字签名

混合加密中，发送端用公钥加密后，再用私钥加密消息计算出的散列值。
接收端同样计算消息的散列值，将其与加密散列值比对，以此判断消息是否由发送端发送，是否被纂改。

## 证书

我们可以通过再两端间插入一个第三方拦截两端发送的公钥，并生成自己的公私钥进行伪造，从而破译，纂改报文。
为了鉴别得到的公钥的真伪，我们使用公钥证书，即证书来检查。

证书由个人信息，公钥，数字签名组成，数字签名由认证机构（CA）进行。